<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KMBUSA Pilot A/L Results 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital@0;1&display=swap" rel="stylesheet">
<style>
body {
  margin: 0;
  font-family: 'Lora', serif;
  background: #f9f9f9;
  color: #333;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, #00274c, #004080);
  color: white;
  padding: 1rem;
  flex-wrap: wrap;
}
header img {
  max-height: 60px;
}
main {
  max-width: 720px;
  margin: auto;
  padding: 1rem;
}
.search {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}
.search input {
  flex: 1;
  padding: 0.6rem;
  border: 1px solid #00274c;
  border-radius: 4px;
}
.search button {
  background: #00274c;
  color: #ffd700;
  border: none;
  border-radius: 4px;
  padding: 0.6rem 1.2rem;
  cursor: pointer;
  transition: 0.3s;
}
.search button:hover:not(:disabled) {
  background: #fff;
  color: #00274c;
  border: 1px solid #00274c;
}
.certificate {
  position: relative;
  background: #fff;
  border: 2px solid #ffd700;
  border-radius: 8px;
  padding: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: none;
  overflow: hidden;
}

/* ‚úÖ Watermark styling */
.certificate::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 400px;
  height: 400px;
  background: url('kmbusa_logo.png') no-repeat center;
  background-size: contain;
  opacity: 0.05;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.cert-header {
  text-align: center;
  margin-bottom: 1rem;
}
.cert-header h2 {
  margin: 0;
  color: #00274c;
}
.student-info p {
  margin: 0.3rem 0;
}
.student-info strong {
  display: inline-block;
  width: 140px;
  color: #00274c;
}
.score-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}
.score-table th,
.score-table td {
  border: 1px solid #ddd;
  padding: 0.5rem;
  text-align: left;
}
.score-table th {
  background: #00274c;
  color: #ffd700;
}
.chart-container {
  height: 260px;
  margin-top: 1.5rem;
}
.print-btn, .rank-btn {
  display: block;
  width: 100%;
  background: #004080;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 0.8rem;
  margin-top: 1rem;
  font-size: 1rem;
  cursor: pointer;
  transition: 0.3s;
}
.print-btn:hover, .rank-btn:hover {
  background: #ffd700;
  color: #00274c;
}
footer {
  text-align: center;
  padding: 1rem;
  color: #666;
}
.no-result {
  text-align: center;
  color: #c0392b;
  margin-top: 1rem;
}
@media (max-width:600px) {
  .student-info strong { width: 120px; }
}
/* Print optimization */
@media print {
  body { background: #fff; }
  header, .search, footer, .rank-btn { display: none; }
  .certificate { box-shadow: none; border-color: #000; }
}
</style>
</head>
<body>
<header>
  <h1>KMBUSA A/L Results 2025</h1>
  <img src="kmbusa_logo.png" alt="KMBUSA Logo">
</header>

<main>
  <div class="search">
    <input id="query" placeholder="Enter Index or NIC" maxlength="12">
    <button id="searchBtn" disabled>View Results</button>
  </div>
  <div id="loading">Loading data‚Ä¶</div>
  <div id="no-result" class="no-result" style="display:none;">‚ùå No results found.</div>

  <div id="certificate" class="certificate">
    <div class="cert-header"><h2>KMBUSA G.C.E. (A/L) Pilot Examination ‚Äì 2025</h2></div>
    <div class="student-info">
      <p><strong>Index:</strong> <span id="cert-index"></span></p>
      <p><strong>Name:</strong> <span id="cert-name"></span></p>
      <p><strong>NIC:</strong> <span id="cert-nic"></span></p>
      <p><strong>Stream:</strong> <span id="cert-stream"></span></p>
      <p><strong>Total Z:</strong> <span id="cert-z"></span></p>
      <p><strong>District Rank:</strong> <span id="cert-rank"></span></p>
    </div>
    <table class="score-table">
      <thead><tr><th>Subject</th><th>Grade</th></tr></thead>
      <tbody id="score-body"></tbody>
    </table>
    <div class="chart-container"><canvas id="rankChart"></canvas></div>
    <button class="rank-btn" id="viewRankBtn">üìä View Rank Position</button>
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Result Sheet</button>
  </div>
</main>

<footer>&copy; 2025 Kilinochchi Maths Bio Students Association</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let results=[]; let chart=null; 
const btn=document.getElementById('searchBtn'); 
const loading=document.getElementById('loading');

fetch('results_base64.txt')
.then(r=>r.text())
.then(b64=>{const csv=atob(b64.trim());parseCSV(csv);})
.catch(err=>{loading.textContent='Error loading results: '+err.message;});

function parseCSV(csvText){
  const lines=csvText.split(/\r?\n/).filter(l=>l.trim());
  const headers=lines[0].split(',');
  results=lines.slice(1).map(l=>{
    const cells=l.split(',');
    const rec={};
    headers.forEach((h,i)=>rec[h.trim().toLowerCase()]=cells[i]?cells[i].trim():"");
    rec.total_z=parseFloat(rec.total_z||"0");
    rec.district_rank=parseInt(rec.district_rank||"0");
    return rec;
  });
  btn.disabled=false;loading.style.display="none";
}

btn.onclick=()=>{
  const q=document.getElementById('query').value.trim();
  const rec=results.find(r=>r.index===q||r.nic===q||r.nic_number===q);
  const cert=document.getElementById('certificate');
  document.getElementById('no-result').style.display=rec?"none":"block";
  if(!rec){cert.style.display="none";return;}
  cert.style.display="block";
  showResult(rec);
};

function showResult(rec){
  document.getElementById('cert-index').textContent=rec.index;
  document.getElementById('cert-name').textContent=rec.name;
  document.getElementById('cert-nic').textContent=rec.nic||rec.nic_number;
  document.getElementById('cert-stream').textContent=rec.stream.toUpperCase();
  document.getElementById('cert-z').textContent=isNaN(rec.total_z)?"‚Äî":rec.total_z.toFixed(4);
  document.getElementById('cert-rank').textContent=rec.district_rank||"‚Äî";
  const tbody=document.getElementById('score-body');
  tbody.innerHTML="";
  tbody.innerHTML+=`<tr><td>Physics</td><td>${rec.physics_grade||"‚Äî"}</td></tr>`;
  tbody.innerHTML+=`<tr><td>Chemistry</td><td>${rec.chemistry_grade||"‚Äî"}</td></tr>`;
  if(rec.stream.toLowerCase()==='maths'){
    tbody.innerHTML+=`<tr><td>Combined Mathematics</td><td>${rec.combined_maths_grade||"‚Äî"}</td></tr>`;
  } else if(rec.stream.toLowerCase()==='bio'){
    tbody.innerHTML+=`<tr><td>Biology</td><td>${rec.biology_grade||"‚Äî"}</td></tr>`;
  }
  drawZChart(rec);
  document.getElementById('viewRankBtn').onclick=()=>drawRankChart(rec);
}

function drawZChart(rec){
  const ctx=document.getElementById('rankChart');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'bar',
    data:{labels:[rec.index],
      datasets:[{label:'Your Z-Score',data:[rec.total_z],backgroundColor:'#ffd700'}]},
    options:{responsive:true,scales:{y:{min:-4,max:4,title:{display:true,text:'Z-Score Range'}}},
      plugins:{legend:{display:false}}}
  });
}

function drawRankChart(rec){
  const ctx=document.getElementById('rankChart');
  if(chart) chart.destroy();
  const stream=rec.stream.toLowerCase();
  const sameStream=results.filter(r=>r.stream.toLowerCase()===stream&&r.total_z>-10);
  const ranks=sameStream.map(r=>({z:r.total_z,index:r.index}))
    .sort((a,b)=>b.z-a.z);
  const xs=ranks.map((_,i)=>i+1);
  const ys=ranks.map(r=>r.z);
  const you=ranks.findIndex(r=>r.index===rec.index);
  chart=new Chart(ctx,{
    type:'scatter',
    data:{
      datasets:[
        {label:'Students',data:xs.map((x,i)=>({x:x,y:ys[i]})),backgroundColor:'rgba(0,0,0,0.3)'},
        {label:'You',data:[{x:you+1,y:rec.total_z}],backgroundColor:'#ffd700',pointRadius:8}
      ]
    },
    options:{
      responsive:true,
      scales:{
        x:{title:{display:true,text:`District Rank among ${stream.toUpperCase()} Stream`}},
        y:{min:-4,max:4,title:{display:true,text:'Z-Score'}}
      },
      plugins:{legend:{display:false}}
    }
  });
}
</script>
</body>
</html>
